---
title: "industry_analysis"
output: html_document
date: "2025-08-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# Load necessary libraries
library(readxl)
library(tidyverse)
library(purrr)
library(stringr)
library(tidyr)
library(ggplot2)
```

```{r}
# read industry data as individual dataframes
# each dataframe contains the same structure with Year and various measures

aircraft<-read_excel("data/source/industries/aircraft_and_parts.xlsx")
blast<-read_excel("data/source/industries/blast_furnaces_steel_mills.xlsx")
forge<-read_excel("data/source/industries/iron_and_steel_forgings.xlsx")
foundry<-read_excel("data/source/industries/iron_steel_foundries.xlsx")
motor<-read_excel("data/source/industries/motor_vehicles_equipment.xlsx")
ordnance<-read_excel("data/source/industries/ordnance.xlsx")
transport<-read_excel("data/source/industries/other_transport.xlsx")
ship<-read_excel("data/source/industries/ship_building_and_repairing.xlsx")
durgoods<-read_excel("data/source/industries/durgoods.xlsx")
electronics<-read_excel("data/source/industries/electronics.xlsx")
furniture<-read_excel("data/source/industries/furniture.xlsx")
appliances<-read_excel("data/source/industries/appliances.xlsx")
manufacturing<-read_excel("data/source/industries/manufacturing.xlsx")


# List of dataframes and their industry names
industry_list <- list(
  aircraft = aircraft,
  blast = blast,
  forge = forge,
  foundry = foundry,
  motor = motor,
  ordnance = ordnance,
  transport=transport,
  ship = ship,
  durgoods=durgoods,
  electronics=electronics,
  furniture=furniture,
  appliances=appliances,
  manufacturing=manufacturing
)
```


```{r}
## Process industry list safely
industry_list <- lapply(industry_list, function(df) {
  
  # Rename "Year" column if needed
  if("Year" %in% names(df)) names(df)[names(df) == "Year"] <- "year"
  
  # Convert all columns except 'year' to numeric safely
  df <- df %>%
    mutate(across(-year, ~ suppressWarnings(as.numeric(.))))
  
  df
})

# Add industry column
industry_list <- imap(industry_list, ~ .x %>%
                        mutate(industry = .y))

# Combine into a single dataframe
df <- bind_rows(industry_list)

# Reorder columns: year, industry first
df <- df %>%
  select(year, industry, everything())

# Remove temporary variables
rm(list = setdiff(ls(), "df"))
```

```{r}
df <- df %>%
  arrange(industry, year) %>%  # ensure data is sorted by industry and year
  group_by(industry) %>%       # compute some variables per industry
  mutate(
    # Percentages / ratios
    women_pct = women / all_employee * 100,
    prod_per_employee = prod / all_employee,
    
    # Year-over-year percent changes
    all_employee_pct_change = (all_employee - lag(all_employee)) / lag(all_employee) * 100,
    prod_wk_earn_pct_change = (prod_wk_earn - lag(prod_wk_earn)) / lag(prod_wk_earn) * 100,
    prod_hr_earn_pct_change = (prod_hr_earn - lag(prod_hr_earn)) / lag(prod_hr_earn) * 100,
    
    # Aggregates / totals
    net_change = newhire - sep,
    
    # Separation percentages
    quit_pct = quit / all_employee * 100,
    layoff_pct = layoff / all_employee * 100
  ) %>%
  ungroup()  # remove grouping

# Optionally round numeric variables to 2 decimals
df <- df %>%
  mutate(across(where(is.numeric), ~ round(., 2)))
```

```{r}
# Define groups by industry
macro<-c("manufacturing","durgoods")
censusMIC <- c("aircraft", "ordnance", "motor", "ship", "electronics")
MICplus <- c("aircraft","ordnance","motor","ship","electronics","forge","foundry")
nonMIC<-c("furniture","appliances")

#create type variable, base value on above group
df <- df %>%
  mutate(type = case_when(
    industry %in% macro ~ "macro",
    industry %in% censusMIC ~ "censusMIC",
    industry %in% MICplus ~ "MICplus",
    industry %in% nonMIC ~ "nonMIC",
    TRUE ~ "other"  # fallback for any unmatched industry
  ))


# Filter df
df_macro<-df%>%
  filter(industry%in%macro)

df_censusMIC <- df %>%
  filter(industry %in% censusMIC)

df_MICplus<-df%>%
  filter(industry %in% MICplus)

df_nonMIC<-df%>%
  filter(industry%in%nonMIC)
```




```{r}

# Identify numeric variables to create tables and plots for (excluding year and industry)
vars_to_table <- df %>%
  select(-year, -industry) %>%
  names()

#plots and tabels function
save_tables_and_plots <- function(df, table_path = "tables", plot_path = "plots", year_col = "year", industry_col = "industry") {
  
  # Ensure directories exist
  if(!dir.exists(table_path)) dir.create(table_path, recursive = TRUE)
  if(!dir.exists(plot_path)) dir.create(plot_path, recursive = TRUE)
  
  # Identify numeric variables excluding year and industry
  vars_to_table <- df %>%
    select(-all_of(c(year_col, industry_col))) %>%
    names()
  
  for(var in vars_to_table){
    safe_var <- gsub("[^A-Za-z0-9_]", "_", var)
    
    # Create table
    tbl <- df %>%
      select(all_of(c(year_col, industry_col, var))) %>%
      pivot_wider(names_from = all_of(industry_col), values_from = all_of(var)) %>%
      arrange(.data[[year_col]])
    
    write_csv(tbl, file.path(table_path, paste0(safe_var, "_by_industry.csv")))
    
    # Create plot
    p <- ggplot(df, aes(x = .data[[year_col]], y = .data[[var]], color = .data[[industry_col]])) +
      geom_line(size = 1) +
      geom_point(size = 2) +
      scale_x_continuous(breaks = seq(min(df[[year_col]]), max(df[[year_col]]), by = 2)) +
      labs(
        title = paste("Trend of", gsub("_", " ", var), "by Industry"),
        x = year_col,
        y = var,
        color = "Industry"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1)
      )
    
    # Save both PDF and PNG
    ggsave(filename = file.path(plot_path, paste0(safe_var, "_by_industry.pdf")),
           plot = p, width = 10, height = 6)
    ggsave(filename = file.path(plot_path, paste0(safe_var, "_by_industry.png")),
           plot = p, width = 10, height = 6, dpi = 300)
  }
}
```

```{r}
save_tables_and_plots(df, table_path = "tables/all", plot_path = "plots/all")
save_tables_and_plots(df_censusMIC, table_path = "tables/censusMIC", plot_path = "plots/censusMIC")
save_tables_and_plots(df_MICplus, table_path = "tables/MICplus", plot_path = "plots/MICplus")
save_tables_and_plots(df_macro, table_path = "tables/macro", plot_path = "plots/macro")
save_tables_and_plots(df_nonMIC, table_path = "tables/nonMIC", plot_path = "plots/nonMIC")
```


```{r}
# Variables to plot
vars_to_plot <- c("prod_hr_earn", "prod_hr_earn_pct_change", "quit", "women_pct", "prod_per_employee")

# Loop over variables and create plots
for(var in vars_to_plot){
  p <- ggplot(df, aes(x = year, y = .data[[var]], color = industry)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), by = 2)) +
    labs(
      title = paste("Trend of", gsub("_", " ", var), "by Industry"),
      x = "Year",
      y = var,
      color = "Industry"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5),
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
  
  print(p) # display in RStudio / notebook
}
```


